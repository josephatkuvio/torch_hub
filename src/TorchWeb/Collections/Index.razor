@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Components.Authorization;
@using System.Security.Claims;
@attribute [Authorize]
@page "/"

<div class="collections-index">
    <header>
        <div class="nav-header">
            <h1>All Collections</h1>
            @if (User?.IsInRole("admin") == true)
            {
                <h1 @onclick=Go class="nav-admin-opt">Admin Page</h1>
                <button @onclick=Add>Add New Collection</button>
            }
            <h1 @onclick=GoNewUI class="nav-admin-opt2">New UI page</h1>
        </div>

        @if (User != null)
        {
            <h1>Hi!!!!! YOU ARE @User.Identity.Name AND YOU ARE IN ROLE @User.Claims.FirstOrDefault(x => x.Type == ClaimTypes.Role)?.Value. YOUR CLAIMS ARE</h1>
            @foreach (var claim in User.Claims)
            {
                <p>@claim.Type: @claim.Value</p>
            }
            <p>ARE U IN THE ADMIN ROLE? @User.IsInRole("admin")</p>
            <p>ARE U IN THE SUPERVISOR ROLE? @User.IsInRole("supervisor")</p>
            <p>ARE U IN THE BASIC ROLE? @User.IsInRole("basic")</p>
            <p>Your email is: @User.Claims.FirstOrDefault(x => x.Type == "email")?.Value</p>
            <p>Your institution_id is: @User.Claims.FirstOrDefault(x => x.Type == "institution_id")?.Value</p>
            <p>Your user id is: @User.Claims.FirstOrDefault(x => x.Type == ClaimTypes.NameIdentifier)?.Value</p>
        }
    </header>

    @if (Model != null)
    {
        <section>
            @foreach (var collection in Model.Collections)
            {
                @if (collection.Deleted_date == null)
                {
                    <CollectionCard Collection="collection" />
                }
            }
        </section>
    }
</div>

@inject IModalService Modal
@inject AuthenticationStateProvider Auth
@code {
    [CascadingParameter] public ClaimsPrincipal? User { get; set; }
    CollectionsResponse? Model;

    protected override async Task OnInitializedAsync()
    {
        if (User?.Claims.Any(x => x.Type == "institution_id") == false)
            Modal.Show<Torch.Web.Institutions.AddInstitution>();

        Model = await TorchCommands.GetCollectionsAsync();
    }

    async Task Add()
    {
        var modal = Modal.Show<AddCollection>();
        await modal.Result;
        Model = await TorchCommands.GetCollectionsAsync();
    }

    void Go() => Nav.NavigateTo($"/admin-page");

    void GoNewUI() => Nav.NavigateTo($"/new-ui-page");
}